# 幾何拘束を有するロボットの近似設計方針

## 1. 背景と目的

本ロボットは、関節間に幾何学的拘束（例：`theta2 = -2 * theta1`）を有する構造を持ち、すべての関節が独立に駆動可能なわけではない。よって、従来の自由度を前提とした状態空間モデルでは、冗長な変数や拘束不整合が発生する。

本ドキュメントでは、以下を目的とする：

* 拘束付きロボットの**縮約状態空間モデルの構築方法**を明示する
* このモデルに基づいた**LQR制御器設計のための基本方針**を整理する

## 2. モデル導出前提

本ドキュメントでは、以下の前提のもとに議論を進める：

### urdfに明示されていないパラメータ
タイヤの半径：wheel_radius = (77.95 / 2) / 1000 [mm]

- 運動学的ツリー構造
```
universe (JointModelRX)
    └─ root_joint (JointModelFreeFlyer)
        ├── upper_link_R_joint (JointModelRUBY)
        │   └─ lower_link_R_joint (JointModelRUBY)
        │       └─ wheel_R_joint (JointModelRUBY)
        └─ upper_link_L_joint (JointModelRUBY)
            └─ lower_link_L_joint (JointModelRUBY)
                └─ wheel_L_joint (JointModelRUBY)

* ロボットの運動方程式は、フル状態ベクトル `x = [q; dq]` に対してすでに導出済みとする

* モデルは線形化され、状態方程式は以下の形式で与えられている：

  ```
  dx/dt = A * x + B * u
  ```

* `q`：関節角度ベクトル、`dq`：関節角速度、`u`：関節トルク

* 平衡点
- upper_link_R_joint = 52deg
- upper_link_L_joint = 52deg
- lower_link_R_joint = -104deg(下記関節間制約を満たす)
- lower_link_L_joint = -104deg(下記関節間制約を満たす)
- body z位置 = 上記平衡点を非線形順運動学で解いたときのタイヤのz位置拘束(ホイールのz = -半径がz=0)を満たす位置にオフセット
- その他 = 0deg, 0m

## 3. 幾何学的拘束と状態変数の縮約

本モデルでは、関節間に次のような拘束が存在する：

```
theta2 = -2 * theta1
```

この拘束は構造的に常に成り立つため、theta2 を状態変数として保持することは冗長である。
したがって、拘束を満たす**独立変数ベクトル `z`** を定義し、以下のように状態ベクトル `x` を再構成できる：

```
x = T * z
```

ここで、T は拘束を反映した変換行列であり、`z = [theta1; theta3; dtheta1; dtheta3]` のような縮約された状態ベクトルを表す。

## 4. トルク変換の線形近似

本モデルでは、トルクに関しても以下のような拘束関係が存在する：

```
tau2 = f(theta1) * tau1
```

ここで `f(theta1)` は以下の非線形関数として与えられている：

```
f(theta1) = -0.00214 * theta1^2 + 0.2636 * theta1 - 8.4662
```

この関係を線形モデルに反映するため、平衡点 `theta1 = 52 deg`（約 0.907 rad）において定数近似を行う。

具体的には：

```
f(0.907) ≈ -0.00214 * (0.907)^2 + 0.2636 * 0.907 - 8.4662 ≈ -8.228
```

よって、

```
tau2 ≈ -8.228 * tau1
```

この係数を用いて、tau1 に対応する入力成分を変換する入力変換行列 `T_u` を定義し、フル入力 `u_full` を以下のように再構成する：

```
u_full = T_u * u
```

ここで T\_u の例：

```
T_u = [ 1
       -8.228
        0
        0 ]
```

この変換を B 行列に対して適用し、

```
B_reduced = Tᵗ * B * T_u
```

とすることで、拘束に整合した入力系が得られる。

## 5. 縮約モデルにおけるシステム行列

拘束付きの状態および入力に基づき、縮約モデル上での状態方程式は以下のように表現される：

```
dz/dt = A_reduced * z + B_reduced * u
```

ここで：

* `A_reduced = Tᵗ * A * T`
* `B_reduced = T_uᵗ * B * T_u`

と定義される。

状態変数の縮約には状態変換行列 `T`、トルク入力の縮約には入力変換行列 `T_u` を別々に用いる。これにより、状態空間と入力空間の両方が拘束条件に整合した形で低次元に再構成される。

## 6. LQR制御器設計方針

縮約モデルを用いて、LQR制御器は次のように設計される：

```
u = -K * z
```

ここで、K はリカッチ方程式により以下の縮約系で求められる：

```
d/dt z = A_reduced * z + B_reduced * u
J = ∫ (zᵗ Q z + uᵗ R u) dt
```

Q, R は縮約状態 `z` に対応する重み行列であり、設計目標に応じて設定する。

## 7. 実装・使用上の注意点

* 実機においては、拘束を反映した縮約モデルに基づく `z` のみで制御が可能である。一方でシミュレーションでは、非駆動関節や拘束軸も物理的に運動するため、全状態 `x` を明示的に制御する必要がある。そのため、制御出力はフルモデルに再構成される必要がある。
* 状態変数 `z` は `z = T⁺ * x` などで取得し、必要に応じて `x = T * z` により復元する
* トルク出力がフル関節に必要な場合は、`u_full = T_u * u` などで冗長軸に拡張する
* 拘束は平衡点近傍で線形近似されたものであるため、動作範囲外では誤差が生じる可能性がある

## 8. まとめ

幾何学的拘束をもつロボットに対しては、拘束を満たす形で状態空間を縮約し、その空間上で制御器を設計することが数値的安定性・実装容易性の両面で有利である。本方針に基づき、今後の制御器設計を進める。
