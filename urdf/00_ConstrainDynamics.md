# ホイール-地面間拘束を考慮した拘束付き運動方程式の定式化手順

## 本ドキュメントでは、脚車輪型ロボットにおけるホイール-地面間の接触拘束（非滑り・接地）を考慮した、拘束付き運動方程式を構築する一連の流れを整理する。

## 1. 拘束方針

各ホイールは常に地面に接地している（接触点位置の拘束）

各ホイールは地面と滑らずに転がる（接触点位置のx,y方向も拘束）

ホイールは回転することにより前進する（転がり運動は許容）

これらの条件により、1ホイールあたり3本、左右2輪で計6本の拘束式が必要となる。

## 2. 接触点位置拘束の定義

### 2.1 接触点の定義

ホイール中心位置（ワールド座標）を p_w(q)、ホイールのローカルz軸方向ベクトルをワールド座標に変換したものを ê_z(q)、ホイール半径を r とすると、接触点位置は次のように定義される：

```
p_contact(q) = p_w(q) - r * ê_z(q)
```

※ 以前は ê_z(q) = [0, 0, 1] と仮定していたが、ホイールがリンクに接続されて姿勢変化を持つ場合、これは不適切。ローカルz軸のワールド変換ベクトルとして、状態変数qに依存する ê_z(q) を明示的に使う必要がある。

### 2.2 接触点の拘束式（位置レベル）

接触点が地面に接しているという拘束は、z方向の高さに関しては位置レベルで成立するが、x, y方向については非滑り拘束（速度レベル）として扱う必要がある。

したがって、接触点の位置 p_contact(q) と地面点 p_ground の一致を拘束式にするのは z方向のみに適用し、x, y方向については後述の速度レベルの非滑り拘束で定義するのが正しい。

```
Φ_z(q) = [p_contact(q)]_z - [p_ground]_z = 0
```

左右輪に対して適用することで、z方向の位置拘束として2本の式が得られる。

この z 方向の位置拘束は時間微分により接触点の鉛直速度拘束に変換できる：

```
Φ̇_z(q, dq) = d/dt ([p_contact(q)]_z) = 0
```

また、x, y 方向についてはホイール回転による接触点の相対速度を考慮した非滑り拘束が次のように記述される：

```
Φ̇_xy(q, dq) = [v_contact(q, dq)]_{x,y} = 0
```

ここで v_contact(q, dq) はホイール中心速度と角速度から定義される接触点速度であり、これら x, y, z 各方向の速度拘束をまとめて次のように書ける：

```
Φ̇_contact(q, dq) = v_contact(q, dq) = 0
```

この統一ベクトル形式により、拘束ヤコビアンや加速度拘束式との接続が明確になる。



### 2.3 2次元簡易モデルによる例

ボディ角度：θ

ホイール回転角：ϕ

ボディの原点位置：p_b = [x; y]

ホイール接続位置：ボディから長さL分下（ボディ座標系の -Y方向）

```
ホイール接触点：p_contact = p_b + R(θ) * [-L; -r]
```

ここで、R(θ) はボディの回転行列。

接触点の位置拘束（地面に接触）：

```
Φ_y(q) = y - L*cos(θ) - r = 0
```

加えて、非滑り拘束（接触点の水平方向速度がゼロ）を考慮すると：

接触点の速度：

```
v_contact = [dx/dt - L*sin(θ)*θ̇;
             dy/dt + L*cos(θ)*θ̇] + r*[sin(θ); -cos(θ)]*ϕ̇
```

ここで、```r*[sin(θ); -cos(θ)]*ϕ̇ ```はホイール回転による接触点速度。

この接触点速度ベクトルの x成分をゼロにする拘束式：

```
Φ̇_x(q, dq) = dx/dt - L*sin(θ)*θ̇ + r*sin(θ)*ϕ̇ = 0
```

これにより、接地（y方向）と非滑り（x方向）の拘束がともに表現される。

加速度レベルでは：

```
d²Φ_y/dt² = ddy/dt² + L*cos(θ)*θ̇² + L*sin(θ)*θ̈ = 0

d²Φ_x/dt² = ddx/dt² - L*cos(θ)*θ̇² - L*sin(θ)*θ̈ + r*cos(θ)*θ̇*ϕ̇ + r*sin(θ)*ϕ̈ = 0
```

これらの導出によって、非線形拘束下の運動方程式へ接続できる。


## 3. 拘束ヤコビアンと加速度拘束式の導出

位置拘束 Φ(q) の1階・2階微分により、速度・加速度レベルの拘束式を得る：

速度拘束：

```
Φ̇(q, dq) = J(q) * dq = 0
```

加速度拘束：

```
Φ̈(q, dq, ddq) = J(q) * ddq + dJ/dt * dq = 0
```

ここで J(q) は p_contact(q) に対するヤコビアンであり、各ホイールごとに3×n行列。
全体では J(q) ∈ ℝ⁶ˣⁿ（n: 全自由度）

## 4. 拘束付き運動方程式の構築

ロボットの運動方程式と拘束条件を連立する：

```
M(q) * ddq + h(q, dq) = τ + Jᵗ(q) * λ
J(q) * ddq + dJ/dt * dq = 0
```

M(q)：質量行列

h(q, dq)：コリオリ・重力項

τ：入力トルク

J(q)：拘束ヤコビアン

λ：ラグランジュ乗数（拘束力）

この連立方程式を用いて ddq と λ を同時に求解する。

## 5. 拘束力を含まない状態方程式への変換（制御設計向け）

上記の連立方程式：

```
[ M   -Jᵗ ] [ddq] = [τ - h  ]
[ J     0 ] [ λ ] = [-dJ/dt * dq]
```

この方程式を解くことで、拘束条件を満たす ```ddq = f(q, dq, τ)``` が得られ、以下のような状態方程式を得る：

```
d/dt [q]   = dq
     [dq] = ddq(q, dq, τ)
```

これにより、拘束を満たす状態方程式が閉じ、LQR や MPC に適用可能な ODE 形式のモデルが得られる。