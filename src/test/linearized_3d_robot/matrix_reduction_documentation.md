# A・B行列縮約実装ドキュメント

## 概要

3次元二足歩行ロボットの線形化システムにおいて、幾何学的拘束とアクチュエータ制約を考慮したA・B行列の縮約実装について詳細を記録する。

## 問題背景

### 元システムの構成
- **フルシステム**: 状態20次元 × 入力10次元
- **状態変数**: `x = [q; dq]` (位置10次元 + 速度10次元)
- **入力変数**: 10次元独立変数に対応

### 制約条件
1. **幾何学的拘束**: `theta2 = -2 * theta1` (下腿 = -2 × 上腿)
2. **トルク拘束**: `tau_lower = f(theta1) * tau_upper` 
3. **アクチュエータ制約**: 物理的に存在する4つの制御入力のみ使用

## 縮約実装詳細

### 1. 状態変換行列T (20×16)

#### 拘束関係の正しい実装
```python
# 正しい拘束: lower = -2 * upper
# 独立変数: [x_base, y_base, pitch, yaw, phi_L_upper, phi_R_upper, wheel_L, wheel_R]

T_q = np.zeros((10, 8))  # 位置変換行列

# 直接コピー部分
T_q[0, 0] = 1.0  # x_base
T_q[1, 1] = 1.0  # y_base  
T_q[2, 2] = 1.0  # pitch
T_q[3, 3] = 1.0  # yaw
T_q[6, 4] = 1.0  # phi_L_upper (独立変数)
T_q[7, 5] = 1.0  # phi_R_upper (独立変数)
T_q[8, 6] = 1.0  # wheel_L
T_q[9, 7] = 1.0  # wheel_R

# 拘束関係部分 (lower = -2 * upper)
T_q[4, 4] = -2.0  # phi_L_lower = -2 * phi_L_upper
T_q[5, 5] = -2.0  # phi_R_lower = -2 * phi_R_upper
```

#### フル状態変換行列
```python
# T (20 × 16)
T = np.zeros((20, 16))
T[:10, :8] = T_q   # 位置部分
T[10:, 8:] = T_q   # 速度部分（同じ構造）
```

### 2. 入力変換行列T_u (6×4)

#### Pinocchio関節順序との対応
```python
# Pinocchio関節順序: [L_upper, L_lower, wheel_L, R_upper, R_lower, wheel_R]
# 縮約入力: [tau_L_upper, tau_R_upper, tau_wheel_L, tau_wheel_R]

T_u = np.zeros((6, 4))

# 直接コピー部分（独立入力）
T_u[0, 0] = 1.0  # tau_L_upper (独立入力)
T_u[2, 2] = 1.0  # tau_wheel_L  
T_u[3, 1] = 1.0  # tau_R_upper (独立入力)
T_u[5, 3] = 1.0  # tau_wheel_R

# トルク拘束関係 (lower = f_eq * upper)
f_eq = -8.229  # 平衡点でのトルク係数
T_u[1, 0] = f_eq  # tau_L_lower = f_eq * tau_L_upper
T_u[4, 1] = f_eq  # tau_R_lower = f_eq * tau_R_upper
```

### 3. B行列の縮約処理

#### 重要な発見: 次元の不整合問題
**問題**: フルシステムB行列は`(20, 10)`だが、実アクチュエータは6次元

**解決方法**: B行列から関節トルク対応列のみを抽出
```python
# B_full.shape = (20, 10): 10次元独立変数に対応
# 独立変数順序: [x_base, y_base, pitch, yaw, phi_L_lower, phi_R_lower, phi_L_upper, phi_R_upper, wheel_L, wheel_R]
# 関節トルク部分: インデックス [4, 5, 6, 7, 8, 9] (6次元)

joint_indices = [4, 5, 6, 7, 8, 9]  # 関節トルク部分
B_joints = B_full[:, joint_indices]  # (20, 6)
```

#### 縮約システム行列の計算
```python
A_reduced = T.T @ A_full @ T           # (16, 16)
B_reduced = T.T @ B_joints @ T_u       # (16, 4)
```

## 実装上の重要ポイント

### 1. 拘束関係の方向
❌ **間違い**: `upper = -2 * lower`
✅ **正しい**: `lower = -2 * upper`

### 2. 独立変数の選択
- **上腿角度**を独立変数とする（物理的により自然）
- 下腿角度は拘束により決定される従属変数

### 3. B行列の次元対応
- Pinocchio全10次元入力 → 関節トルク6次元 → 実アクチュエータ4次元
- 各段階での適切な次元抽出が重要

### 4. トルク拘束の線形近似
```python
# 非線形関数: f(theta1) = -0.00214*theta1^2 + 0.2636*theta1 - 8.4662
# 平衡点 52deg での線形化: f_eq ≈ -8.229
```

## 検証結果

### 成功指標
✅ **次元整合性**: A_reduced(16,16), B_reduced(16,4)
✅ **安定性**: 縮約システムで安定極2個確認
✅ **制御可能性**: 4次元制御入力で16次元状態制御
✅ **物理実現性**: 実際のアクチュエータのみ使用

### 縮約効果
- **状態縮約**: 20次元 → 16次元 (80%)
- **入力縮約**: 10次元 → 4次元 (40%)
- **計算効率**: 大幅な計算負荷削減

## 最終的な縮約システム

### 状態空間表現
```
dz/dt = A_reduced * z + B_reduced * u
```

### 制御入力構成
```python
u = [
    tau_L_upper,   # [0] 左上腿関節トルク
    tau_R_upper,   # [1] 右上腿関節トルク  
    tau_wheel_L,   # [2] 左ホイールトルク
    tau_wheel_R    # [3] 右ホイールトルク
]
```

### 物理的意味
- **上腿制御**: 姿勢安定化とバランス制御
- **ホイール制御**: 前進・後退・旋回運動
- **下腿トルク**: 上腿トルクから自動的に決定（拘束により）

## 今後の拡張可能性

### 1. 動的拘束の考慮
- 平衡点以外での非線形拘束関数の適用
- 適応的線形化による動作範囲拡大

### 2. さらなる縮約
- 左右対称性を利用した3次元制御入力
- ホイール差動制御の統合

### 3. 実機適用
- アクチュエータ特性に基づく制約追加
- センサ情報を活用した状態推定統合

---

**作成日**: 2025-08-03
**実装ファイル**: `constraint_reduction.py`
**検証ファイル**: `test_linearization.py`