# URDF Single Leg

URDF single_legモデルを使用した拘束付き動力学シミュレーション。simple_testで開発された拘束理論をURDFロボットモデルに適用し、高精度なノンスリップ拘束を実現。

## システム概要

### モデル構成
- **ロボット**: フローティングベース（6自由度） + 股関節 + 膝関節 + ホイール
- **総自由度**: 9自由度
- **拘束条件**: 
  - 接地拘束（ホイール底面が地面に接触）
  - ノンスリップ拘束（ホイール中心移動距離 = タイヤ回転距離）

### 実装バリエーション
1. **シンプル拘束** (`simple_constrained.py`): 接地拘束のみ → 5自由度
2. **ノンスリップ拘束** (`noslip_constrained.py`): 接地+ノンスリップ → 4自由度

## ファイル構成

### 主要シミュレーション
| ファイル | 機能 | 自由度 | 説明 |
|---------|------|--------|------|
| `simple_urdf_test.py` | URDF読み込みテスト | - | 基本的なURDF読み込みと可視化 |
| `simple_constrained.py` | シンプル拘束シミュレーション | 5→3 | 接地拘束のみ適用 |
| `noslip_constrained.py` | ノンスリップ拘束シミュレーション | 6→4 | 高精度ノンスリップ拘束 |

### ユーティリティ
| ファイル | 機能 |
|---------|------|
| `animation_utils.py` | 2Dアニメーション表示機能 |
| `plotting_utils.py` | 静止画グラフ表示機能 |
| `noslip_verification.py` | 拘束精度検証システム |
| `run_verification.py` | 独立した検証実行スクリプト |

## 使用方法

### 1. 基本シミュレーション実行

```bash
# シンプル拘束シミュレーション（5自由度→3自由度）
python simple_constrained.py

# ノンスリップ拘束シミュレーション（6自由度→4自由度）
python noslip_constrained.py
```

### 2. 拘束精度検証（独立実行）

```bash
# インタラクティブ検証（自動でシミュレーション実行）
python run_verification.py

# 保存済み結果ファイルから検証
python run_verification.py noslip_results_phi1_0.3_phi2_-0.6.pkl
```

## 技術的特徴

### 拘束実装手法
- **位置ベース拘束**: タイヤ角度をホイール中心位置から直接計算
- **高精度実現**: 累積角度追跡により2π跨ぎ問題を解決
- **検証精度**: 機械精度レベル（10^-16～10^-17）のノンスリップ拘束満足

### 動力学計算
- **Pinocchio**: 運動方程式導出、ヤコビアン計算、順運動学
- **拘束縮約**: 独立変数のみでの運動方程式構築
- **数値積分**: Euler法による時間発展

### 可視化機能
- **2Dアニメーション**: ロボットの動作、質量中心軌跡、ホイール回転表示
- **静止画グラフ**: 関節角度、ベース位置、ホイール回転角度の時系列
- **検証グラフ**: 拘束誤差の可視化

## システム設計原則

### 関心事の分離
- **計算**: `*_dynamics()`関数で純粋な動力学計算
- **表示**: `*_utils.py`でアニメーション・グラフ機能
- **検証**: 独立したスクリプトで事後検証
- **統合**: メイン関数で計算と表示を結合

### データフロー
```
動力学計算 → 結果保存(.pkl) → 表示機能
                ↓
           独立検証スクリプト
```

## 物理的動作

### 期待される挙動
- **初期**: ロボットが傾斜姿勢で静止
- **落下**: 重力によりベースが降下
- **振り子運動**: ホイール接地により複雑な多重振り子挙動
- **ノンスリップ**: ホイールが滑らず正確に回転

### 検証項目
- **接地拘束**: ホイール底面が常に地面（Z=0）に接触
- **ノンスリップ拘束**: ホイール中心移動距離とタイヤ回転距離の一致
- **数値精度**: 拘束誤差が機械精度レベル以下

## 参考情報

### 関連プロジェクト
- **`src/test/simple_test`**: 2次元単純化モデル（理論検証用）
- **`src/test/urdf_robot_2D`**: URDF読み込み基礎テスト
- **`urdf/model_info.md`**: ロボットモデル詳細情報

### 技術仕様
- **ホイール半径**: 38.975mm
- **シミュレーション時間**: 3秒（デフォルト）
- **時間刻み**: 0.02秒
- **拘束許容誤差**: 10^-12～10^-14

## 注意事項

- 制御入力は一切与えず、重力による自由応答のみをシミュレート
- 数値安定性のため、拘束は位置レベルで直接満足させる手法を採用
- 検証システムは完全に分離されており、シミュレーション実行に影響しない