# LQR制御器開発における線形化問題の発見と分析

**作業日時**: 2025年8月3日 17:45  
**セッション概要**: LQR制御器のテスト中にピッチ角制御不可能問題を発見し、根本原因を特定

## 🚨 発見された重大な問題

### 問題の発端
LQR制御器の制御可能性テストにおいて、**ボディのピッチ角（前後傾斜）が制御不可能**として判定される異常な結果が発生。物理的に上腿トルクやホイールトルクでピッチ角制御は可能なはずだが、制御入力ゼロとなる現象を確認。

### 制御可能性分析結果
- **制御可能状態**: 8/16状態
  - 上腿関節角度（左右）とその角速度
  - ホイール角度（左右）とその角速度
- **制御不可能状態**: 8/16状態  
  - ベース位置: x_base, y_base
  - **ベース姿勢: pitch, yaw**（←本来制御可能なはず）
  - ベース速度: dx_base, dy_base, dpitch, dyaw

## 🔍 根本原因の特定

### 1. 線形化システムの調査
**ファイル**: `/src/test/linearized_3d_robot/linearized_dynamics.py`

**問題箇所**: `_compute_acceleration_symbolic()` 関数（107-110行目）
```python
ddq_sym = cs.vertcat(*[
    self.tau_sym[i] - 9.81 * cs.sin(self.q_sym[i % self.n_q]) 
    for i in range(self.n_q)
])
```

**問題内容**:
- 各自由度を**独立した単振り子**として扱っている
- **関節間の結合**を完全に無視
- **慣性行列**を無視した極度の簡略化
- CasADiの制約でPinocchioとの統合が不完全

### 2. 実際の動力学との比較検証

**検証方法**: `debug_linearization.py`で数値微分による正確な線形化を実施

**元の線形化結果**（間違い）:
```
制御入力からピッチ角速度への影響:
  tau_x          : 0.000000
  tau_y          : 0.000000  
  tau_pitch      : 1.000000  ← ピッチトルクのみ
  tau_yaw        : 0.000000
  tau_phi_L_lower: 0.000000  ← 関節トルクの影響なし
  tau_phi_R_lower: 0.000000
  tau_phi_L_upper: 0.000000  ← 上腿トルクの影響なし
  tau_phi_R_upper: 0.000000
  tau_wheel_L    : 0.000000  ← ホイールトルクの影響なし
  tau_wheel_R    : 0.000000
```

**数値線形化結果**（正しい）:
```
制御入力からピッチ角速度への影響:
  tau_x          : 0.043304   ✅
  tau_y          : -0.001776  ✅
  tau_pitch      : 54.963939  ✅
  tau_yaw        : -0.046567  ✅
  tau_phi_L_lower: 0.220075   ✅
  tau_phi_R_lower: 0.154858   ✅
  tau_phi_L_upper: -54.891594 ✅ ← 大きな影響！
  tau_phi_R_upper: -54.911364 ✅ ← 大きな影響！
  tau_wheel_L    : -0.292640  ✅
  tau_wheel_R    : -0.207608  ✅
```

### 3. 実動力学テストでの確認
```
各制御入力がピッチ角加速度に与える影響:
  tau_phi_L_upper: ddq_pitch = -56.220556 ← 大きな影響
  tau_phi_R_upper: ddq_pitch = -56.240327 ← 大きな影響
  tau_wheel_L    : ddq_pitch = -1.621603  ← 影響あり
  tau_wheel_R    : ddq_pitch = -1.536571  ← 影響あり
```

## 📊 定量的な問題の規模

**B行列ノルムの比較**:
- 元の線形化: **3.162278**（大幅に過小評価）
- 数値線形化: **833.165437**（正確な値）
- **差のノルム: 831.230714**（約264倍の誤差）

この結果は、線形化システムが**実際の動力学を264分の1程度しか表現できていない**ことを示している。

## 🔧 実装ファイルの詳細

### 作成した調査・検証ファイル
1. **`analyze_controllable_basis.py`**: 制御可能部分空間の詳細分析
2. **`debug_linearization.py`**: 線形化問題の調査と数値微分による正確な線形化

### 影響を受けるファイル
1. **`/src/test/linearized_3d_robot/linearized_dynamics.py`** ← 修正が必要
2. **`/src/test/linearized_3d_robot/constraint_reduction.py`** ← 正しい線形化結果で再計算が必要
3. **`/src/test/lqr_controller_3d/practical_lqr_controller.py`** ← 修正後の線形化結果で再設計が必要

## 💡 解決方向性

### 短期的解決策
1. **数値微分による線形化**: CasADiの不完全な実装を回避し、数値微分で正確な線形化行列を取得
2. **線形化結果の更新**: 正しいA・B行列で制御可能性解析と縮約処理を再実行
3. **LQR制御器の再設計**: 正しい線形化結果に基づくLQR制御器の設計

### 長期的解決策
1. **CasADi統合の改善**: Pinocchioとの統合を改善し、正確なシンボリック微分を実現
2. **動力学モデルの検証**: URDFモデルと動力学計算の整合性確認

## 🎯 技術的達成事項

1. **問題の特定**: 制御不可能性の根本原因を線形化誤差に特定
2. **定量的分析**: 264倍の誤差という具体的な問題規模を数値化
3. **検証手法確立**: 数値微分による線形化検証手法を確立
4. **修正方向性提示**: 正確な線形化による解決策を提示

## 📋 次回セッション向け作業予定

### 優先度：高
1. **線形化システムの修正**: 数値微分ベースの正確な線形化実装
2. **制御可能性の再解析**: 修正後の線形化での制御可能性確認
3. **LQR制御器の再設計**: 正しい動力学に基づく制御器設計

### 優先度：中
1. **CasADi統合の改善**: より正確なシンボリック微分の実現
2. **動力学検証の強化**: URDFモデルと計算結果の整合性検証

## 🔗 関連ファイルパス
- `/src/test/linearized_3d_robot/linearized_dynamics.py` - 線形化実装（要修正）
- `/src/test/urdf_full_robot_3d/fixed_robot_3d.py` - 基本動力学計算
- `/src/test/lqr_controller_3d/debug_linearization.py` - 問題調査用（新規作成）
- `/src/test/lqr_controller_3d/analyze_controllable_basis.py` - 制御可能性分析（新規作成）

## 📝 重要な教訓

1. **物理的直感の重要性**: 制御工学において物理的におかしい結果は必ず原因がある
2. **数値検証の価値**: シンボリック計算が困難な場合の数値微分の有効性
3. **段階的デバッグ**: 制御可能性→線形化→動力学の順序でのトラブルシューティング

---

**次回継続ポイント**: 数値微分による正確な線形化実装から開始し、ピッチ角制御可能な正しいLQRシステムの構築を目指す。